import React, { useEffect, useMemo, useState } from "react";

/**
 * App Instrutor de Voo — React/TSX (sem Babel no navegador)
 *
 * Correção do erro: o canvas estava interpretando o documento como index.tsx,
 * mas o conteúdo anterior começava com um HTML completo ("<!doctype html>").
 * Agora entregamos um **componente React padrão** (export default) para rodar
 * diretamente no ambiente do canvas (code/react) sem precisar de Babel inline.
 *
 * Mantido todo o comportamento:
 * - Abas: Inicial, Informações, Ficha Técnica, Check-out
 * - Carrega CSVs (PP, PC, INVA)
 * - Regras de horário Zulu + botões "Agora (Zulu)"
 * - Local vs Navegação, múltiplas pernas (+30/+30), somas hh:mm e décimos
 * - Ficha Técnica com dados da missão(s)
 * - Check-out pré-preenchido e compartilhamento no WhatsApp
 * - Pequenos testes via console.assert (mantidos e expandidos)
 */

/************ Utilidades de Tempo (Zulu) ************/
const pad2 = (n: number) => n.toString().padStart(2, "0");
const toZulu = (date: Date = new Date()) => `${pad2(date.getUTCHours())}:${pad2(date.getUTCMinutes())}`;
const parseHHMM = (hhmm?: string | null) => {
  if (!hhmm) return null;
  const parts = hhmm.split(":");
  if (parts.length !== 2) return null;
  const h = Number(parts[0]);
  const m = Number(parts[1]);
  if (Number.isNaN(h) || Number.isNaN(m)) return null;
  return h * 60 + m; // minutos
};
const minutesToHHMM = (mins: number) => `${pad2(Math.floor(mins / 60))}:${pad2(mins % 60)}`;
const minutesToDecimalHours = (mins: number) => (Math.round((mins / 60) * 10) / 10).toFixed(1);
const addMinutes = (hhmm: string | null | undefined, mins: number) => {
  const base = parseHHMM(hhmm) ?? 0;
  const total = base + mins;
  const day = 24 * 60;
  const wrapped = ((total % day) + day) % day;
  return minutesToHHMM(wrapped);
};
const diffHHMM = (a?: string | null, b?: string | null) => {
  const am = parseHHMM(a) ?? 0;
  const bm = parseHHMM(b) ?? 0;
  let d = bm - am;
  if (d < 0) d += 24 * 60; // ajuste simples de rollover
  return d;
};

/************ Dados e listas ************/
const FASES = ["PP", "PPR", "PC", "INVA", "PLA"] as const;
const AERONAVES = ["PR-FLE", "PR-FLD", "PR-FLN", "PT-MJF", "PR-MGX", "PR-FLM"] as const;
const TIPOS_VOO = ["Local", "Navegação"] as const;

type Fase = typeof FASES[number];

type MissoesMap = Record<string, string[]>;
const MISSOES_POR_FASE: MissoesMap = {
  PP: [
    "PS-01","PS-02","PS-03","PS-04","PS-05","PS-06","PS-07","PS-08","PS-09","PS-10",
    "PS-11","PS-12","PS-13","PS-14","PS-15","PS-16","PS-17","PS-X1","PS-18",
    "AP-01","AP-02","AP-03","AP-04","AP-05","AP-06","AP-07","AP-08","AP-09",
    "NV-01","NV-02","NV-03","NV-X1",
    "NT-01","NT-02","NT-03",
    "PRCQ","CQPP"
  ],
  PPR: [
    "PS-03","PS-05","PS-07","PS-10","PS-15","PS-17","PS-X1","PS-18",
    "AP-01","AP-05","AP-06","AP-07","AP-08","AP-09",
    "NV-01","NV-02","NV-03","NV-X1",
    "NT-01","NT-02","NT-03",
    "PRCQ","CQPP"
  ],
  PC: [
    "AD-01","AD-02","AD-03","AD-04","AD-05","AD-06","AD-07","AD-08",
    "AP-01","AP-02","AP-03","AP-04","AP-05","AP-06","AP-07","AP-08",
    "MB-01","MB-02","MB-03","MB-04","MB-05","MB-06",
    "NV-01","NV-02","NV-03","NV-04","NV-05","NV-06","NV-07","NV-08",
    "NV-09","NV-10","NV-11","NV-12","NV-13","NV-14","NV-15",
    "NT-01","NT-02","NT-03","NT-04","NT-05",
    "PRCQ","CQPP"
  ],
  INVA: [
    "PI-01","PI-02","PI-03","PI-04","PI-05","PI-06","PI-07","PI-08",
    "PI-09","PI-10","PI-11","PI-12","PI-13","PI-14","PI-15","PI-16",
    "NV-01","NV-02",
    "PRCQ","CQPP"
  ],
  PLA: []
};

const CSV_LINKS: Record<string, string> = {
  PP: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi36jUxlUkQBmzYm7DpFG3HH9GQoiYbGdybwxf8mnYPjY3EDgrNnpCqu4BN9B7censF_2xcpH7WxZq/pub?gid=0&single=true&output=csv",
  PC: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi36jUxlUkQBmzYm7DpFG3HH9GQoiYbGdybwxf8mnYPjY3EDgrNnpCqu4BN9B7censF_2xcpH7WxZq/pub?gid=1936904888&single=true&output=csv",
  INVA: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi36jUxlUkQBmzYm7DpFG3HH9GQoiYbGdybwxf8mnYPjY3EDgrNnpCqu4BN9B7censF_2xcpH7WxZq/pub?gid=2094617121&single=true&output=csv"
};

/************ CSV parser ************/
function splitCSVLine(line: string): string[] {
  const res: string[] = [];
  let cur = ""; let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') {
      if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) { res.push(cur); cur = ""; }
    else cur += ch;
  }
  res.push(cur);
  return res;
}
function parseCSV(text: string): Record<string, string>[] {
  const lines = text.replace(/\r/g, "").split("\n").filter(Boolean);
  if (!lines.length) return [];
  const header = splitCSVLine(lines[0]);
  const rows: Record<string, string>[] = [];
  for (let i = 1; i < lines.length; i++) {
    const cells = splitCSVLine(lines[i]);
    const obj: Record<string, string> = {};
    header.forEach((h, idx) => obj[h.trim()] = (cells[idx] ?? "").trim());
    rows.push(obj);
  }
  return rows;
}
function lookupMissao(fase: Fase, codigo: string, dadosCSV: Record<string, Record<string, string>[]>) {
  const baseFase = fase === 'PPR' ? 'PP' : fase;
  if (!codigo) return null;
  const arr = dadosCSV[baseFase] || [];
  const keyNames = ["Missão", "Missao", "Código", "Codigo", "Missao/Cod", "Missao Cod", "Missao ", "Missão "];
  const found = arr.find(row => keyNames.some(k => (row[k] || "").toUpperCase().includes(codigo.toUpperCase())));
  if (found) return found;
  const alt = arr.find(row => Object.values(row).some(v => (v || "").toUpperCase() === codigo.toUpperCase()));
  return alt || null;
}

/************ Componentes utilitários ************/
function Section({ title, children, right }: { title: string; children: React.ReactNode; right?: React.ReactNode; }) {
  return (
    <div className="bg-white rounded-2xl shadow p-4 mb-4">
      <div className="flex items-center justify-between mb-3">
        <h2 className="text-lg font-semibold">{title}</h2>
        {right}
      </div>
      {children}
    </div>
  );
}
function Select({ value, onChange, options, placeholder }: { value: string; onChange: (v: string) => void; options: string[]; placeholder?: string; }) {
  return (
    <select className="w-full border rounded-xl px-3 py-2" value={value} onChange={(e) => onChange(e.target.value)}>
      <option value="">{placeholder ?? "Selecione"}</option>
      {options.map(op => <option key={op} value={op}>{op}</option>)}
    </select>
  );
}
function Input({ value, onChange, placeholder }: { value: string; onChange: (v: string) => void; placeholder?: string; }) {
  return (
    <input className="w-full border rounded-xl px-3 py-2" value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} />
  );
}
function TimePicker({ label, value, onChange, onNow }: { label: string; value: string; onChange: (v: string) => void; onNow: () => void; }) {
  const [h, m] = (value || "00:00").split(":");
  const hours = [...Array(24)].map((_, i) => pad2(i));
  const mins = [...Array(60)].map((_, i) => pad2(i));
  return (
    <div className="flex items-center gap-2 mb-2">
      <div className="w-36 text-sm font-medium">{label}</div>
      <div className="flex items-center gap-2">
        <select className="border rounded-xl px-2 py-1" value={h} onChange={(e) => onChange(`${e.target.value}:${m}`)}>
          {hours.map(x => <option key={x} value={x}>{x}</option>)}
        </select>
        <span>:</span>
        <select className="border rounded-xl px-2 py-1" value={m} onChange={(e) => onChange(`${h}:${e.target.value}`)}>
          {mins.map(x => <option key={x} value={x}>{x}</option>)}
        </select>
        <button className="text-xs border rounded-lg px-2 py-1" onClick={onNow}>Agora (Zulu)</button>
      </div>
    </div>
  );
}

/************ Hook relógio Zulu ************/
function useZuluClock() {
  const [now, setNow] = useState(toZulu());
  useEffect(() => {
    const id = setInterval(() => setNow(toZulu()), 1000);
    return () => clearInterval(id);
  }, []);
  return now;
}

/************ Componente principal ************/
export default function App() {
  // Inicial
  const [aluno, setAluno] = useState("");
  const [canac, setCanac] = useState("");
  const [dataVoo, setDataVoo] = useState(new Date().toISOString().slice(0, 10));
  const [fase, setFase] = useState<Fase>("PP");
  const [missoes, setMissoes] = useState<string[]>([""]);

  // Informações do voo
  const [aeronave, setAeronave] = useState("");
  const [tipoVoo, setTipoVoo] = useState<(typeof TIPOS_VOO)[number]>("Local");

  const zuluInit = useMemo(() => toZulu(), []);
  const [acionamento, setAcionamento] = useState(zuluInit);
  const [decolagem, setDecolagem] = useState(addMinutes(zuluInit, 10));
  const [pouso, setPouso] = useState(addMinutes(zuluInit, 55));
  const [corte, setCorte] = useState(addMinutes(zuluInit, 60));
  const [pernas, setPernas] = useState<{ dec: string; pouso: string; }[]>([]);

  const [aba, setAba] = useState("Inicial");
  const zuluClock = useZuluClock();

  // CSV
  const [dadosCSV, setDadosCSV] = useState<Record<string, Record<string, string>[]>>({ PP: [], PC: [], INVA: [] });
  const [loadingCSV, setLoadingCSV] = useState(false);
  const [erroCSV, setErroCSV] = useState("");

  useEffect(() => {
    (async () => {
      setLoadingCSV(true); setErroCSV("");
      try {
        const entries = await Promise.all(Object.entries(CSV_LINKS).map(async ([k, url]) => {
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Falha ao baixar CSV ${k}`);
          const text = await res.text();
          return [k, parseCSV(text)] as const;
        }));
        setDadosCSV(Object.fromEntries(entries));
      } catch (e: any) {
        setErroCSV(String(e?.message || e));
      } finally {
        setLoadingCSV(false);
      }
    })();
  }, []);

  // Regras ao alterar acionamento
  useEffect(() => {
    setDecolagem(addMinutes(acionamento, 10));
    setPouso(addMinutes(acionamento, 55));
    setCorte(addMinutes(acionamento, 60));
    if (tipoVoo === "Navegação" && pernas.length > 0) {
      let cur = decolagem;
      const novas = pernas.map((p, idx) => {
        const dec = idx === 0 ? decolagem : addMinutes(cur, 30);
        const ps = addMinutes(dec, 30);
        cur = ps;
        return { dec, pouso: ps };
      });
      setPernas(novas);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [acionamento]);

  // Troca de tipo de voo
  useEffect(() => {
    if (tipoVoo === "Local") setPernas([]);
    else setPernas([{ dec: addMinutes(decolagem, 30), pouso: addMinutes(decolagem, 60) }]);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [tipoVoo]);

  // Totais
  const totalAcionCorteMin = useMemo(() => diffHHMM(acionamento, corte), [acionamento, corte]);
  const totalAcionCorteHHMM = minutesToHHMM(totalAcionCorteMin);
  const totalAcionCorteDec = minutesToDecimalHours(totalAcionCorteMin);

  const totalDecPousoLocalMin = useMemo(() => diffHHMM(decolagem, pouso), [decolagem, pouso]);
  const totalDecPousoLocalHHMM = minutesToHHMM(totalDecPousoLocalMin);
  const totalDecPousoLocalDec = minutesToDecimalHours(totalDecPousoLocalMin);

  const totaisNavegacao = useMemo(() => {
    let mins = 0;
    const detalhes = pernas.map(p => {
      const d = diffHHMM(p.dec, p.pouso);
      mins += d;
      return { ...p, dMin: d, dHHMM: minutesToHHMM(d), dDec: minutesToDecimalHours(d) };
    });
    return { detalhes, somaMin: mins, somaHHMM: minutesToHHMM(mins), somaDec: minutesToDecimalHours(mins) };
  }, [pernas]);

  // Ficha técnica e Check-out default
  const ficha = useMemo(() => {
    const selecionadas = missoes.filter(Boolean);
    if (!selecionadas.length) return [] as Record<string, string>[];
    return selecionadas.map((cod) => lookupMissao(fase, cod, dadosCSV)).filter(Boolean) as Record<string, string>[];
  }, [missoes, fase, dadosCSV]);

  const textoCheckoutDefault = useMemo(() => {
    const linhas: string[] = [];
    ficha.forEach((m) => {
      if (!m) return;
      const nome = m.Missao || m["Missão"] || m["Missao"];
      if (nome) linhas.push(`Missão ${nome}`);
      const conteudo = m["Conteúdo / Manobras"] || m["Conteudo / Manobras"] || m["Conteúdo"] || m["Conteudo"];
      if (conteudo) String(conteudo).split(/;|\n/).map(s => s.trim()).filter(Boolean).forEach(it => linhas.push(`- ${it}`));
    });
    return linhas.join("\n");
  }, [ficha]);

  const [textoCheckout, setTextoCheckout] = useState("");
  useEffect(() => { setTextoCheckout(textoCheckoutDefault); }, [textoCheckoutDefault]);

  // Testes (mantidos + expandidos)
  useEffect(() => {
    console.log('[TEST] Iniciando testes utilitários...');
    console.assert(pad2(3) === '03', 'pad2');
    console.assert(addMinutes('23:50', 20) === '00:10', 'addMinutes wrap');
    console.assert(diffHHMM('23:50', '00:10') === 20, 'diff midnight');
    console.assert(minutesToHHMM(65) === '01:05', 'm2hhmm');
    console.assert(minutesToDecimalHours(6) === '0.1', 'dec .1h');
    // novos casos
    console.assert(addMinutes('00:00', -1) === '23:59', 'addMinutes negativo wrap');
    console.assert(diffHHMM('00:10', '00:05') === 23*60+55, 'diff reverse wrap');
    console.log('[TEST] OK');
  }, []);

  function addMissao() { setMissoes(prev => [...prev, ""]); }
  function removeMissao(i: number) { setMissoes(prev => prev.filter((_, idx) => idx !== i)); }
  function addPerna() {
    setPernas(prev => {
      if (prev.length === 0) return [{ dec: addMinutes(decolagem, 30), pouso: addMinutes(decolagem, 60) }];
      const last = prev[prev.length - 1];
      const nextDec = addMinutes(last.pouso, 30);
      const nextPouso = addMinutes(nextDec, 30);
      return [...prev, { dec: nextDec, pouso: nextPouso }];
    });
  }
  function shareWhatsApp() {
    const linhas: string[] = [];
    linhas.push(`Aluno: ${aluno || '-'}`);
    linhas.push(`CANAC: ${canac || '-'}`);
    linhas.push(`Data do Voo: ${dataVoo || '-'}`);
    linhas.push(`Fase: ${fase}`);
    const mslist = missoes.filter(Boolean).join(', ') || '-';
    linhas.push(`Missões: ${mslist}`);
    linhas.push('');
    linhas.push('Informações do Voo:');
    linhas.push(`Aeronave: ${aeronave || '-'}`);
    linhas.push(`Tipo de Voo: ${tipoVoo}`);

    if (tipoVoo === 'Local') {
      linhas.push(`Acionamento: ${acionamento}`);
      linhas.push(`Decolagem: ${decolagem}`);
      linhas.push(`Pouso: ${pouso}`);
      linhas.push(`Corte: ${corte}`);
      linhas.push(`Total (Acion.-Corte): ${totalAcionCorteHHMM} — ${totalAcionCorteDec}`);
      linhas.push(`Total (Dec.-Pouso): ${totalDecPousoLocalHHMM} — ${totalDecPousoLocalDec}`);
    } else {
      linhas.push(`Acionamento: ${acionamento}`);
      linhas.push(`Decolagem Base: ${decolagem}`);
      pernas.forEach((p, i) => { linhas.push(`Perna ${i + 1} — Dec: ${p.dec} / Pouso: ${p.pouso}`); });
      linhas.push(`Corte: ${corte}`);
      linhas.push(`Total pernas: ${totaisNavegacao.somaHHMM} — ${totaisNavegacao.somaDec}`);
      linhas.push(`Total (Acion.-Corte): ${totalAcionCorteHHMM} — ${totalAcionCorteDec}`);
    }

    linhas.push('');
    linhas.push('Check-out:');
    linhas.push(textoCheckout || '-');

    const msg = encodeURIComponent(linhas.join('\n'));
    if (typeof window !== 'undefined') window.open(`https://wa.me/?text=${msg}`, '_blank');
  }

  return (
    <div className="min-h-screen bg-slate-100 text-slate-900 max-w-md mx-auto p-3">
      <header className="sticky top-0 z-10 bg-slate-100 pb-2">
        <h1 className="text-xl font-bold">App Instrutor de Voo</h1>
        <div className="mt-2 grid grid-cols-4 gap-2 text-sm">
          {['Inicial', 'Informações', 'Ficha Técnica', 'Check-out'].map(tab => (
            <button key={tab} className={`rounded-2xl px-3 py-2 border ${aba === tab ? 'bg-slate-900 text-white' : 'bg-white'}`} onClick={() => setAba(tab)}>{tab}</button>
          ))}
        </div>
      </header>

      {aba === 'Inicial' && (
        <main className="pt-3">
          <Section title="Dados do Aluno">
            <div className="grid grid-cols-1 gap-3">
              <Input value={aluno} onChange={setAluno} placeholder="Nome do Aluno" />
              <Input value={canac} onChange={setCanac} placeholder="CANAC do Aluno" />
              <div>
                <label className="text-sm font-medium mb-1 block">Data do Voo</label>
                <input type="date" className="w-full border rounded-xl px-3 py-2" value={dataVoo} onChange={(e) => setDataVoo(e.target.value)} />
              </div>
            </div>
          </Section>

          <Section title="Planejamento">
            <div className="grid grid-cols-1 gap-3">
              <div>
                <label className="text-sm font-medium mb-1 block">Fase da Instrução</label>
                <Select value={fase} onChange={(v) => { setFase(v as Fase); setMissoes([""]); }} options={[...FASES]} placeholder="Escolha a fase" />
              </div>
              <div>
                <label className="text-sm font-medium mb-1 block">Missões</label>
                {missoes.map((m, idx) => (
                  <div key={idx} className="flex items-center gap-2 mb-2">
                    <Select value={m} onChange={(v) => setMissoes(prev => prev.map((x, i) => i === idx ? v : x))} options={MISSOES_POR_FASE[fase] || []} placeholder="Selecione a missão" />
                    {missoes.length > 1 && (
                      <button className="text-xs border px-2 py-1 rounded-lg" onClick={() => removeMissao(idx)}>Remover</button>
                    )}
                  </div>
                ))}
                <button className="mt-1 text-sm border rounded-xl px-3 py-2" onClick={addMissao}>+ Adicionar missão</button>
              </div>
            </div>
          </Section>
        </main>
      )}

      {aba === 'Informações' && (
        <main className="pt-3">
          <Section title="Informações do Voo" right={<span className="text-xs">Zulu: <b>{zuluClock}Z</b></span>}>
            <div className="grid grid-cols-1 gap-3">
              <div>
                <label className="text-sm font-medium mb-1 block">Aeronave</label>
                <Select value={aeronave} onChange={setAeronave} options={[...AERONAVES]} placeholder="Selecione a aeronave" />
              </div>
              <div>
                <label className="text-sm font-medium mb-1 block">Tipo de Voo</label>
                <Select value={tipoVoo} onChange={(v) => setTipoVoo(v as any)} options={[...TIPOS_VOO]} placeholder="Local ou Navegação" />
              </div>

              <div className="border rounded-2xl p-3">
                <TimePicker label="Acionamento" value={acionamento} onChange={setAcionamento} onNow={() => setAcionamento(toZulu())} />

                {tipoVoo === 'Local' && (
                  <>
                    <TimePicker label="Decolagem" value={decolagem} onChange={setDecolagem} onNow={() => setDecolagem(toZulu())} />
                    <TimePicker label="Pouso" value={pouso} onChange={setPouso} onNow={() => setPouso(toZulu())} />
                    <TimePicker label="Corte" value={corte} onChange={setCorte} onNow={() => setCorte(toZulu())} />
                  </>
                )}

                {tipoVoo === 'Navegação' && (
                  <>
                    <TimePicker label="Decolagem (Base)" value={decolagem} onChange={setDecolagem} onNow={() => setDecolagem(toZulu())} />
                    {pernas.map((p, idx) => (
                      <div key={idx} className="border rounded-xl p-2 mb-2">
                        <div className="text-xs mb-1 font-medium">Perna {idx + 1}</div>
                        <TimePicker label="Decolagem" value={p.dec} onChange={(v) => setPernas(prev => prev.map((x, i) => i === idx ? { ...x, dec: v } : x))} onNow={() => setPernas(prev => prev.map((x, i) => i === idx ? { ...x, dec: toZulu() } : x))} />
                        <TimePicker label="Pouso" value={p.pouso} onChange={(v) => setPernas(prev => prev.map((x, i) => i === idx ? { ...x, pouso: v } : x))} onNow={() => setPernas(prev => prev.map((x, i) => i === idx ? { ...x, pouso: toZulu() } : x))} />
                      </div>
                    ))}
                    <button className="text-sm border rounded-xl px-3 py-2 mb-2" onClick={addPerna}>+ Adicionar Decolagem/Pouso</button>
                    <TimePicker label="Corte" value={corte} onChange={setCorte} onNow={() => setCorte(toZulu())} />
                  </>
                )}
              </div>

              <div className="border rounded-2xl p-3">
                <div className="text-sm font-semibold mb-2">Totais</div>
                {tipoVoo === 'Local' ? (
                  <div className="space-y-1 text-sm">
                    <div>Total (Acionamento → Corte): <b>{totalAcionCorteHHMM}</b> — <b>{totalAcionCorteDec}</b></div>
                    <div>Total (Decolagem → Pouso): <b>{totalDecPousoLocalHHMM}</b> — <b>{totalDecPousoLocalDec}</b></div>
                  </div>
                ) : (
                  <div className="space-y-1 text-sm">
                    {totaisNavegacao.detalhes.map((d, i) => (
                      <div key={i}>Perna {i + 1}: {d.dHHMM} — {d.dDec}</div>
                    ))}
                    <div className="mt-1">Soma das pernas: <b>{totaisNavegacao.somaHHMM}</b> — <b>{totaisNavegacao.somaDec}</b></div>
                    <div>Total (Acionamento → Corte): <b>{totalAcionCorteHHMM}</b> — <b>{totalAcionCorteDec}</b></div>
                  </div>
                )}
              </div>

              <div className="text-center text-xs text-slate-600">Relógio Zulu em destaque: <span className="font-bold">{zuluClock}Z</span></div>
            </div>
          </Section>
        </main>
      )}

      {aba === 'Ficha Técnica' && (
        <main className="pt-3">
          <Section title="Ficha Técnica da Missão">
            {loadingCSV && <div className="text-sm">Carregando missões...</div>}
            {erroCSV && <div className="text-sm text-red-600">{erroCSV}</div>}
            {ficha.length === 0 && !loadingCSV && (
              <div className="text-sm">Selecione ao menos uma missão na aba Inicial.</div>
            )}
            <div className="space-y-4">
              {ficha.map((m, idx) => (
                <div key={idx} className="border rounded-2xl p-3">
                  <div className="text-sm"><b>Missão:</b> {m?.Missao || m?.["Missão"] || missoes[idx] || '-'}</div>
                  <div className="text-sm"><b>Tempo de Voo:</b> {m?.Tempo || m?.["Tempo de Voo"] || '-'}</div>
                  <div className="text-sm"><b>Pousos:</b> {m?.Pousos || '-'}</div>
                  <div className="text-sm"><b>Pré-requisitos:</b> {m?.["Pré-requisitos"] || m?.["Pre-requisitos"] || '-'}</div>
                  <div className="text-sm"><b>Registro:</b> {m?.Registro || '-'}</div>
                  <div className="text-sm"><b>Competências:</b> {m?.["Competências"] || m?.["Competencias"] || '-'}</div>
                  <div className="text-sm"><b>Conteúdo / Manobras:</b><br />{(m?.["Conteúdo / Manobras"] || m?.["Conteudo / Manobras"] || m?.["Conteúdo"] || m?.["Conteudo"]) || '-'}</div>
                </div>
              ))}
            </div>
          </Section>
        </main>
      )}

      {aba === 'Check-out' && (
        <main className="pt-3">
          <Section title="Check-out">
            <div className="mb-2 text-xs text-slate-600">O texto abaixo vem pré-preenchido a partir das missões selecionadas. Edite livremente.</div>
            <textarea className="w-full h-56 border rounded-2xl p-3 text-sm" value={textoCheckout} onChange={(e) => setTextoCheckout(e.target.value)} />
            <div className="flex gap-2 mt-3">
              <button className="rounded-2xl px-4 py-2 bg-emerald-600 text-white shadow" onClick={shareWhatsApp}>Compartilhar no WhatsApp</button>
            </div>
          </Section>
        </main>
      )}

      <footer className="h-10" />
    </div>
  );
}
