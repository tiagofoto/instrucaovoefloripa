<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Instrução de Voo — Floripa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light" />
</head>
<body class="min-h-screen bg-gray-100">
  <div class="max-w-md mx-auto">
    <!-- Header / Tabs -->
    <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
      <div class="px-4 py-3 flex items-center justify-between">
        <div class="text-lg font-semibold"></div><!-- título removido -->
        <div class="text-xs text-gray-500">Protótipo</div>
      </div>
      <nav class="px-2 pb-2 grid grid-cols-4 gap-2" id="tabs"></nav>
    </header>

    <!-- App -->
    <main id="app" class="pb-6"></main>

    <footer class="px-4 py-6 text-center text-xs text-gray-400">
      © <span id="year"></span> — Protótipo para instrutores de voo
    </footer>
  </div>

  <script>
    // ==========================
    // FONTE DOS DADOS (planilhas publicadas em CSV)
    // ==========================
    const CSV_URLS = {
      PP: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi36jUxlUkQBmzYm7DpFG3HH9GQoiYbGdybwxf8mnYPjY3EDgrNnpCqu4BN9B7censF_2xcpH7WxZq/pub?gid=0&single=true&output=csv",
      PC: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi36jUxlUkQBmzYm7DpFG3HH9GQoiYbGdybwxf8mnYPjY3EDgrNnpCqu4BN9B7censF_2xcpH7WxZq/pub?gid=1936904888&single=true&output=csv",
      INVA: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQi36jUxlUkQBmzYm7DpFG3HH9GQoiYbGdybwxf8mnYPjY3EDgrNnpCqu4BN9B7censF_2xcpH7WxZq/pub?gid=2094617121&single=true&output=csv"
    };

    // ==========================
    // DADOS (carregados dinamicamente das planilhas)
    // ==========================
    const MISSOES = { PP:{}, PC:{}, INVA:{} };
    const FASES = ["PP","PPR","PC","INVA","PLA"]; // PPR/PLA seguem fixos
    const MISSOES_POR_FASE = { PP:[], PPR:[], PC:[], INVA:[], PLA:[] };

    // Mapeamento de colunas tolerante a variações de nomes/casos/acentos
    const COLMAP = {
      code: ["codigo","código","missao","missão","cod","code"],
      tempo: ["tempo","tempo_voo","tempodevoo"],
      pousos: ["pousos","pouso"],
      conteudo: ["conteudo","conteúdo","manobras","conteudo/manobras"],
      prereq: ["pre-requisitos","pré-requisitos","prerequisitos","prereq","pre_req"],
      registro: ["registro","reg"],
      competencias: ["competencias","competências","competencia","competência"]
    };

    // ==========================
    // STATE
    // ==========================
    const state = {
      dadosCarregados: { PP:false, PC:false, INVA:false },
      erroCarregamento: null,
      aba: "Inicial",
      form: { nomeAluno:"", canacAluno:"", dataVoo:"", fase:"PP", missoes:[""] },
      voo: { tipoVoo:"Local", aeronave:"", local:{}, navegacao:{} },
      clockZulu: "--:--",
      checkoutTexto: "",
      _checkoutInit: false
    };

    // ==========================
    // CSV helpers (parser simples com suporte a aspas)
    // ==========================
    function normalizeHeader(s){
      return String(s||"")
        .toLowerCase()
        .normalize('NFD').replace(/\p{Diacritic}/gu,'')
        .replace(/[^a-z0-9]/g,'');
    }
    function csvParse(text){
      const rows = [];
      let i=0, field='', row=[], inQuotes=false;
      while(i < text.length){
        const c = text[i];
        if (inQuotes){
          if (c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
          if (c==='"'){ inQuotes=false; i++; continue; }
          field += c; i++; continue;
        } else {
          if (c==='"'){ inQuotes=true; i++; continue; }
          if (c===','){ row.push(field); field=''; i++; continue; }
          if (c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; i++; continue; }
          if (c==='\r'){ i++; continue; }
          field += c; i++; continue;
        }
      }
      // último campo
      row.push(field); rows.push(row);
      return rows;
    }
    function csvToObjects(text){
      const rows = csvParse(text).filter(r=> r.length && r.some(x=>String(x).trim()!==''));
      if (!rows.length) return [];
      const headers = rows[0].map(normalizeHeader);
      return rows.slice(1).map(r=>{
        const o={};
        headers.forEach((h,idx)=> o[h] = r[idx]??'');
        return o;
      });
    }
    function pick(obj, keys){ const out={}; keys.forEach(k=> out[k]=obj[k]); return out; }
    function firstMatchKey(obj, names){
      for (const k of Object.keys(obj)){
        const nk = normalizeHeader(k);
        if (names.includes(nk)) return k;
      }
      return null;
    }
    function parseMissionsCSV(text){
      // gera mapping flexível a partir do cabeçalho original
      const rowsRaw = csvParse(text);
      if (!rowsRaw.length) return { list:[], map:{} };
      const headerRow = rowsRaw[0];
      const headerNorm = headerRow.map(h=>normalizeHeader(h));
      const findCol = (arr)=>{
        for (let i=0;i<headerNorm.length;i++) if (arr.includes(headerNorm[i])) return i;
        return -1;
      };
      const idx = {
        code: findCol(COLMAP.code),
        tempo: findCol(COLMAP.tempo),
        pousos: findCol(COLMAP.pousos),
        conteudo: findCol(COLMAP.conteudo),
        prereq: findCol(COLMAP.prereq),
        registro: findCol(COLMAP.registro),
        competencias: findCol(COLMAP.competencias)
      };
      const list=[], map={};
      for (let r=1;r<rowsRaw.length;r++){
        const row = rowsRaw[r];
        const code = (idx.code>=0? row[idx.code]: '').trim();
        if (!code) continue;
        const tempo_voo = (idx.tempo>=0? row[idx.tempo]: '').trim();
        const pousos = (idx.pousos>=0? row[idx.pousos]: '').trim();
        const conteudo = (idx.conteudo>=0? row[idx.conteudo]: '').trim();
        const prereq = (idx.prereq>=0? row[idx.prereq]: '').trim();
        const registro = (idx.registro>=0? row[idx.registro]: '').trim();
        const competencias = (idx.competencias>=0? row[idx.competencias]: '').trim();

        list.push(code);
        map[code] = {
          tempo_voo: tempo_voo || "-",
          pousos: pousos? Number(pousos.replace(/[^0-9]/g,'')) : undefined,
          conteudo: conteudo ? [conteudo] : [],
          pre_requisitos: prereq ? prereq.split(/;|,|\n/).map(s=>s.trim()).filter(Boolean) : [],
          registro: registro || "",
          competencias: competencias ? competencias.split(/;|,|\n/).map(s=>s.trim()).filter(Boolean) : []
        };
      }
      return { list, map };
    }

    async function loadCSV(url){
      // Tenta buscar direto; se bloquear por CORS, tenta fallback com proxy de leitura r.jina.ai
      const ctrl = new AbortController();
      const t = setTimeout(()=> ctrl.abort(), 12000);
      try{
        const res = await fetch(url, { cache:'no-store', signal: ctrl.signal });
        clearTimeout(t);
        if (!res.ok) throw new Error(`Falha ao carregar: ${res.status}`);
        return await res.text();
      }catch(err){
        clearTimeout(t);
        // fallback CORS-friendly
        try{
          const noScheme = url.replace(/^https?:\/\//i, '');
          const proxyUrl = `https://r.jina.ai/http://${noScheme}`; // proxy faz o fetch server-side e habilita CORS
          const res2 = await fetch(proxyUrl, { cache:'no-store' });
          if (!res2.ok) throw new Error(`Falha proxy: ${res2.status}`);
          return await res2.text();
        }catch(err2){
          throw new Error(`Erro ao carregar planilha (CORS/bloqueio): ${err2.message||err2}`);
        }
      }
    });
      if (!res.ok) throw new Error(`Falha ao carregar: ${res.status}`);
      return await res.text();
    }
    async function loadAllDatasets(){
      try{
        // Carrega e converte PP / PC / INVA
        for (const fase of ["PP","PC","INVA"]){
          const text = await loadCSV(CSV_URLS[fase]);
          const { list, map } = parseMissionsCSV(text);
          MISSOES[fase] = map;
          MISSOES_POR_FASE[fase] = list.length ? list : MISSOES_POR_FASE[fase];
          state.dadosCarregados[fase] = true;
        }
        // Mantém listas para PPR/PLA como estavam (se desejar podemos derivar a partir de PP mais tarde)
        render();
      }catch(err){
        console.error(err);
        state.erroCarregamento = String(err.message||err);
        render();
      }
    }

    // ==========================
    // HORA ZULU helpers
    // ==========================
    const pad2 = (n)=> String(n).padStart(2,"0");
    const dateToZuluHM = (d)=> `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}`;
    const addMinutesZulu = (baseHM, minutes)=>{
      const [h,m] = baseHM.split(":").map(Number);
      const base = new Date(); base.setUTCHours(h, m, 0, 0);
      const nd = new Date(base.getTime() + minutes*60*1000);
      return dateToZuluHM(nd);
    };
    const diffHMtoMinutes = (startHM, endHM)=>{
      const [sh,sm] = startHM.split(":").map(Number);
      const [eh,em] = endHM.split(":").map(Number);
      let start = sh*60 + sm; let end = eh*60 + em; if (end < start) end += 24*60;
      return end - start;
    };
    const minutesToHHMM = (mins)=> `${pad2(Math.floor(mins/60))}:${pad2(mins%60)}`;

    // Trunca em décimos de hora (0,1h = 6 min) e devolve string com vírgula
    function minutesToDecimalTenthsStr(mins){
      const tenths = Math.floor(mins / 6);         // 6 min = 0,1h (truncado)
      const str = (tenths / 10).toFixed(1);        // "1.8"
      return str.replace(".", ",");              // "1,8"
    }

    // ==========================
    // WhatsApp (somente Check-out)
    // ==========================
    async function shareWhatsApp(text, numero){
      try {
        if (navigator.share && (!navigator.canShare || navigator.canShare({ text }))){
          await navigator.share({ text });
          return;
        }
      } catch {}
      const base = numero ? `https://wa.me/${numero}?text=` : `https://api.whatsapp.com/send?text=`;
      window.open(base + encodeURIComponent(text), "_blank");
    }

    // ==========================
    // Helpers UI
    // ==========================
    function Field(label, inner){
      return `
        <div class="flex flex-col gap-1">
          <label class="text-sm text-gray-700">${label}</label>
          ${inner}
        </div>`;
    }
    function Select(options, value, attrs=""){
      const opts = options.map(o=>`<option value="${o}" ${o===value?'selected':''}>${o}</option>`).join("");
      return `<select ${attrs} class="w-full border rounded-xl p-3 pr-8 bg-white">${opts}</select>`;
    }
    function Input(value, attrs=""){
      return `<input ${attrs} class="w-full border rounded-xl p-3 bg-white" value="${value||""}" />`;
    }
    function TextArea(value, attrs=""){
      return `<textarea ${attrs} class="w-full border rounded-2xl p-3 bg-white resize-none">${value||""}</textarea>`;
    }
    function TimeField(id, label, value){
      const [hh="00", mm="00"] = String(value||"00:00").split(":").map(x=>pad2(+x||0));
      const HOURS = Array.from({length:24}, (_,i)=>pad2(i)).map(h=>`<option value="${h}" ${h===hh?'selected':''}>${h}</option>`).join("");
      const MINUTES = Array.from({length:60}, (_,i)=>pad2(i)).map(m=>`<option value="${m}" ${m===mm?'selected':''}>${m}</option>`).join("");
      const html = `
        <div class="flex flex-col gap-1">
          <label class="text-sm text-gray-700">${label}</label>
          <div class="flex items-center gap-2">
            <select data-id="${id}" data-part="hh" class="border rounded-xl p-3">${HOURS}</select>
            <span class="text-gray-500">:</span>
            <select data-id="${id}" data-part="mm" class="border rounded-xl p-3">${MINUTES}</select>
            <button type="button" data-id="${id}" data-action="nowz" class="ml-2 px-3 py-2 rounded-xl border bg-white text-xs">Agora (Z)</button>
          </div>
          <input type="hidden" id="${id}" value="${hh}:${mm}" />
        </div>`;
      return html;
    }
    function bindTimeField(id, onChange){
      const hh = document.querySelector(`select[data-id="${id}"][data-part="hh"]`);
      const mm = document.querySelector(`select[data-id="${id}"][data-part="mm"]`);
      const hidden = document.getElementById(id);
      const btn = document.querySelector(`button[data-id="${id}"][data-action="nowz"]`);
      function update(){ hidden.value = `${hh.value}:${mm.value}`; hidden.dispatchEvent(new Event("change")); }
      if (hh) hh.onchange = update;
      if (mm) mm.onchange = update;
      if (hidden) hidden.addEventListener("change", ()=> onChange(hidden.value));
      if (btn) btn.onclick = ()=>{ const n=new Date(); hh.value=pad2(n.getUTCHours()); mm.value=pad2(n.getUTCMinutes()); update(); };
    }

    function semicolonSplitToItems(raw){
      const arr = Array.isArray(raw) ? raw : [String(raw||"")];
      return arr.flatMap(s=> String(s).split(";")).map(x=>x.trim()).filter(Boolean);
    }
    function datasetByFase(fase){
      if (fase==="PC") return MISSOES.PC;
      if (fase==="INVA") return MISSOES.INVA;
      if (fase==="PP" || fase==="PPR") return MISSOES.PP;
      return {};
    }

    // ==========================
    // Relatórios / Somatórios
    // ==========================
    function pageInfoResultados(){
      if ((state.voo.tipoVoo||"Local")==="Local"){
        const minsTotal = diffHMtoMinutes(state.voo.local?.acionamento||"00:00", state.voo.local?.corte||"00:00");
        const minsVoo   = diffHMtoMinutes(state.voo.local?.decolagem  ||"00:00", state.voo.local?.pouso  ||"00:00");
        return { totalHHMM: minutesToHHMM(minsTotal), totalDecimal: minutesToDecimalTenthsStr(minsTotal), vooHHMM: minutesToHHMM(minsVoo), vooDecimal: minutesToDecimalTenthsStr(minsVoo), pernas:[] };
      } else {
        const acion = state.voo.navegacao?.acionamento || "00:00";
        const corte = state.voo.navegacao?.corte || "00:00";
        const minsTotal = diffHMtoMinutes(acion, corte);
        const pernas = (state.voo.navegacao?.perna||[]).map(p=>{
          const mm = diffHMtoMinutes(p.decolagem||"00:00", p.pouso||"00:00");
          return { ...p, hhmm: minutesToHHMM(mm), dec: minutesToDecimalTenthsStr(mm) };
        });
        return { totalHHMM: minutesToHHMM(minsTotal), totalDecimal: minutesToDecimalTenthsStr(minsTotal), vooHHMM:null, vooDecimal:null, pernas };
      }
    }
    function formatInfoVooForText(){
      const r = pageInfoResultados();
      const tipo = state.voo.tipoVoo || 'Local';
      const aeronave = state.voo.aeronave || '-';
      if (tipo === 'Local'){
        return [
          'INFORMAÇÕES DO VOO',
          `Aeronave: ${aeronave}`,
          `Tipo de voo: ${tipo}`,
          `Acionamento (Z): ${state.voo.local?.acionamento || '-'}`,
          `Decolagem (Z): ${state.voo.local?.decolagem || '-'}`,
          `Pouso (Z): ${state.voo.local?.pouso || '-'}`,
          `Corte (Z): ${state.voo.local?.corte || '-'}`,
          `Total (Acion→Corte): ${r.totalHHMM} — ${r.totalDecimal} h`,
          `Decolagem→Pouso: ${r.vooHHMM} — ${r.vooDecimal} h`,
          ''
        ].join('\n');
      } else {
        const linhas = [
          'INFORMAÇÕES DO VOO',
          `Aeronave: ${aeronave}`,
          `Tipo de voo: ${tipo}`,
          `Acionamento (Z): ${state.voo.navegacao?.acionamento || '-'}`,
        ];
        (state.voo.navegacao?.perna||[]).forEach((p, i)=>{
          const mm = diffHMtoMinutes(p.decolagem||'00:00', p.pouso||'00:00');
          linhas.push(`Perna ${i+1} — Decolagem (Z): ${p.decolagem||'-'} | Pouso (Z): ${p.pouso||'-'} | Tempo: ${minutesToHHMM(mm)} — ${minutesToDecimalTenthsStr(mm)} h`);
        });
        linhas.push(`Corte (Z): ${state.voo.navegacao?.corte || '-'}`);
        linhas.push(`Total (Acion→Corte): ${r.totalHHMM} — ${r.totalDecimal} h`);
        linhas.push('');
        return linhas.join('\n');
      }
    }

    // ==========================
    // Páginas
    // ==========================
    function PageInicial(){
      const todayISO = new Date().toISOString().slice(0,10);
      if (!state.form.dataVoo) state.form.dataVoo = todayISO;

      // monta a lista de missões com base na fase atual; se vazio, usa placeholder
      const lista = MISSOES_POR_FASE[state.form.fase||"PP"];
      const missoes = (state.form.missoes||[]).map((m,idx)=>`
        <div class="p-3 rounded-2xl border shadow-sm bg-white flex items-center gap-3">
          ${Select(["",...(lista?.length? lista: [""])], m, `data-ev="missao" data-idx="${idx}"`)}
          <button class="ml-auto text-sm text-red-600" data-ev="remove-missao" data-idx="${idx}">Remover</button>
        </div>`).join("");

      // status de carregamento
      const flags = state.dadosCarregados;
      const status = !flags.PP && !flags.PC && !flags.INVA ?
        '<div class="text-xs text-gray-500">Carregando planilhas…</div>' :
        `<div class="text-xs ${flags.PP&&flags.PC&&flags.INVA?'text-green-600':'text-amber-600'}">Planilhas: PP ${flags.PP?'ok':'…'} • PC ${flags.PC?'ok':'…'} • INVA ${flags.INVA?'ok':'…'}</div>`;

      const err = state.erroCarregamento ? `<div class="text-xs text-red-600">${state.erroCarregamento}. Dica: abra pelo GitHub Pages (HTTPS) ou deixe que o app use o fallback interno.</div>` : '';

      return `
        <div class="p-4 flex flex-col gap-4">
          ${status}${err}
          <div class="grid grid-cols-1 gap-4">
            ${Field("Nome do Aluno", Input(state.form.nomeAluno, `data-ev="nomeAluno" placeholder="Digite o nome"`))}
            ${Field("CANAC do Aluno", Input(state.form.canacAluno, `data-ev="canacAluno" placeholder="Ex.: 123456"`))}
            ${Field("Data do Voo", `<input type="date" class="w-full border rounded-xl p-3" value="${state.form.dataVoo||todayISO}" data-ev="dataVoo" />`)}
            ${Field("Fase da Instrução", Select(FASES, state.form.fase||"PP", `data-ev="fase"`))}
          </div>

          <div class="mt-2">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-gray-700">Missões</span>
              <button class="px-3 py-1 rounded-xl bg-black text-white" data-ev="add-missao">+ Adicionar</button>
            </div>
            <div class="flex flex-col gap-3">${missoes}</div>
          </div>
        </div>`;
    }

    function PageInfoVoo(){
      const nowHM = dateToZuluHM(new Date());
      if (!state.voo.local?.acionamento && state.voo.tipoVoo!=="Navegação"){
        const acion = nowHM, deco = addMinutesZulu(acion,10), pouso = addMinutesZulu(acion,55), corte = addMinutesZulu(acion,60);
        state.voo = {
          aeronave: state.voo.aeronave||"",
          tipoVoo: state.voo.tipoVoo||"Local",
          local: { acionamento: acion, decolagem: deco, pouso, corte },
          navegacao: state.voo.navegacao || { acionamento: acion, perna: [{ decolagem: deco, pouso: addMinutesZulu(deco,30)}], corte }
        };
      }

      const tipoLocal = `
        ${TimeField("l-acion","Acionamento (Zulu)", state.voo.local?.acionamento||"")}
        ${TimeField("l-decol","Decolagem (Zulu)", state.voo.local?.decolagem||"")}
        ${TimeField("l-pouso","Pouso (Zulu)", state.voo.local?.pouso||"")}
        ${TimeField("l-corte","Corte (Zulu)", state.voo.local?.corte||"")}
      `;
      const pernas = (state.voo.navegacao?.perna||[]).map((p,idx)=>`
        <div class="p-3 rounded-2xl border bg-white shadow-sm">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium">Perna ${idx+1}</span>
            <button class="text-xs text-red-600" data-ev="remove-perna" data-idx="${idx}">Remover</button>
          </div>
          <div class="grid grid-cols-1 gap-3">
            ${TimeField(`n-dec-${idx}`,"Decolagem (Zulu)", p.decolagem)}
            ${TimeField(`n-pou-${idx}`,"Pouso (Zulu)", p.pouso)}
          </div>
        </div>
      `).join("");
      const tipoNav = `
        ${TimeField("n-acion","Acionamento (Zulu)", state.voo.navegacao?.acionamento||"")}
        ${pernas}
        <button class="w-full rounded-2xl bg-black text-white py-2" data-ev="add-perna">+ Adicionar Decolagem/Pouso</button>
        ${TimeField("n-corte","Corte (Zulu)", state.voo.navegacao?.corte||"")}
      `;

      const r = pageInfoResultados();

      return `
        <div class="p-4 flex flex-col gap-4">
          <div class="grid grid-cols-1 gap-4">
            ${Field("Aeronave", Select(["",...AERONAVES], state.voo.aeronave||"", `data-ev="aeronave"`))}
            ${Field("Tipo de Voo", Select(TIPOS_VOO, state.voo.tipoVoo||"Local", `data-ev="tipoVoo"`))}
          </div>

          ${(state.voo.tipoVoo||"Local")==="Local" ? `<div class="grid grid-cols-1 gap-3">${tipoLocal}</div>` : `<div class="grid grid-cols-1 gap-3">${tipoNav}</div>`}

          <div class="mt-2 p-3 rounded-2xl bg-gray-50 border">
            <div class="text-sm text-gray-600 mb-1">Somatórios</div>
            <div class="text-sm">Total (Acionamento → Corte): <b>${r.totalHHMM}</b> – <b>${r.totalDecimal} h</b></div>
            ${(state.voo.tipoVoo||"Local")==="Local"
              ? `<div class="text-sm">Decolagem → Pouso: <b>${r.vooHHMM}</b> – <b>${r.vooDecimal} h</b></div>`
              : `<div class="text-sm flex flex-col gap-1">
                  ${r.pernas.map((p,i)=>`<div>Perna ${i+1} (Dec→Pou): <b>${p.hhmm}</b> – <b>${p.dec} h</b></div>`).join("")}
                </div>`
            }
          </div>

          <div class="sticky bottom-3 p-4 rounded-2xl bg-black text-white text-center text-xl tracking-wider">
            Horário Zulu: <b id="clockZulu">${state.clockZulu}Z</b>
          </div>
        </div>`;
    }

    function PageFichaTecnica(){
      const ds = datasetByFase(state.form.fase);
      const cods = (state.form.missoes||[]).filter(Boolean);
      const carregando = (state.form.fase==='PP' && !state.dadosCarregados.PP) || (state.form.fase==='PC' && !state.dadosCarregados.PC) || (state.form.fase==='INVA' && !state.dadosCarregados.INVA);

      if (carregando){
        return `<div class="p-4 text-sm text-gray-500">Carregando dados da planilha…</div>`;
      }

      const infos = cods.map(code=>({ code, data: ds?.[code] }));

      const itens = infos.map(m=>`
        <div class="p-4 rounded-2xl border bg-white shadow-sm">
          <div class="text-lg font-semibold mb-2">Missão: ${m.code}</div>
          ${!m.data ? `<div class="text-sm text-red-600">Não encontrado na planilha.</div>` : `
            <div class="flex flex-col gap-2 text-sm">
              <div><b>Tempo de Voo:</b> ${m.data.tempo_voo||"-"}</div>
              <div><b>Pousos:</b> ${m.data.pousos ?? "-"}</div>
              <div><b>Pré-requisitos:</b> ${(m.data.pre_requisitos||[]).join(", ") || "-"}</div>
              <div><b>Registro:</b> ${m.data.registro || "-"}</div>
              <div><b>Competências:</b> ${(m.data.competencias||[]).join(", ") || "-"}</div>
              <div>
                <b>Conteúdo / Manobras:</b>
                <div class="mt-1">Missão ${m.code}</div>
                <ul class="ml-5">
                  ${semicolonSplitToItems(m.data.conteudo).map((c,i,arr)=>`<li>- ${c}${i<arr.length-1?';':''}</li>`).join("")}
                </ul>
              </div>
            </div>`}
        </div>
      `).join("");

      return `
        <div class="p-4 flex flex-col gap-4">
          ${infos.length===0 ? `<div class="text-sm text-gray-500">Selecione ao menos uma missão na página inicial.</div>` : ""}
          ${itens}
        </div>`;
    }

    function PageCheckout(){
      const ds = datasetByFase(state.form.fase);
      const cods = (state.form.missoes||[]).filter(Boolean);
      if (!state._checkoutInit){
        const linhas=[];
        cods.forEach(code=>{
          const d = ds?.[code];
          linhas.push(`Missão ${code}`);
          if (d && d.conteudo){
            const itens = semicolonSplitToItems(d.conteudo);
            itens.forEach((it,idx)=> linhas.push(`- ${it}${idx<itens.length-1?';':''}`));
          }
          linhas.push("");
        });
        state.checkoutTexto = linhas.join("\n");
        state._checkoutInit = true;
      }

      // Altura do textarea até o rodapé (sem rolagem extra)
      const headerH = 56 + 48; // aprox header + tabs
      const footerH = 56;      // aprox footer
      const padding = 24 + 48; // paddings/margens
      const vh = Math.max(document.documentElement.clientHeight || 0, window.innerHeight || 0);
      const taHeight = Math.max(200, vh - headerH - footerH - padding);

      return `
        <div class="p-4 flex flex-col gap-3">
          <div class="text-sm text-gray-600">Escreva aqui sua avaliação (livre). O texto vem pré-preenchido com o descritivo da(s) missão(ões), podendo ser editado.</div>
          <div class="flex gap-2 mb-2">
            <button class="px-3 py-2 rounded-xl bg-black text-white text-xs" data-ev="share-checkout">Compartilhar WhatsApp</button>
          </div>
          ${TextArea(state.checkoutTexto, `data-ev="checkout-texto" style="height:${taHeight}px"`)}
        </div>`;
    }

    // ==========================
    // Render raiz + bindings
    // ==========================
    function render(){
      // tabs
      const tabs = ["Inicial","Informações do voo","Ficha Técnica","Check-out"];
      document.getElementById("tabs").innerHTML = tabs.map(t=>`
        <button data-aba="${t}" class="py-2 rounded-2xl text-sm ${state.aba===t?'bg-black text-white':'bg-gray-200 text-gray-800'}">${t}</button>
      `).join("");

      // page
      const app = document.getElementById("app");
      app.innerHTML =
        state.aba==="Inicial" ? PageInicial()
      : state.aba==="Informações do voo" ? PageInfoVoo()
      : state.aba==="Ficha Técnica" ? PageFichaTecnica()
      : PageCheckout();

      bind();
    }

    function bind(){
      // tabs
      document.querySelectorAll('[data-aba]').forEach(b=>{
        b.onclick = ()=> { state.aba = b.getAttribute('data-aba'); if (state.aba!=="Check-out") state._checkoutInit = false; render(); };
      });

      // Inicial
      const set = (k)=> (e)=> state.form[k] = e.target.value;
      document.querySelectorAll('[data-ev="nomeAluno"]').forEach(el=> el.oninput = set('nomeAluno'));
      document.querySelectorAll('[data-ev="canacAluno"]').forEach(el=> el.oninput = set('canacAluno'));
      document.querySelectorAll('[data-ev="dataVoo"]').forEach(el=> el.oninput = set('dataVoo'));
      const fase = document.querySelector('[data-ev="fase"]'); if (fase) fase.onchange = (e)=>{ state.form.fase = e.target.value; state.form.missoes=[""]; render(); };
      document.querySelectorAll('[data-ev="missao"]').forEach(el=> el.onchange = (e)=>{ const idx=+el.getAttribute('data-idx'); state.form.missoes[idx]=e.target.value; });
      const addM = document.querySelector('[data-ev="add-missao"]'); if (addM) addM.onclick = ()=> { state.form.missoes.push(""); render(); };
      document.querySelectorAll('[data-ev="remove-missao"]').forEach(el=> el.onclick = ()=>{ const idx=+el.getAttribute('data-idx'); state.form.missoes = state.form.missoes.filter((_,i)=>i!==idx); render(); });

      // Info voo
      const aer = document.querySelector('[data-ev="aeronave"]'); if (aer) aer.onchange = (e)=> state.voo.aeronave = e.target.value;
      const tipo = document.querySelector('[data-ev="tipoVoo"]'); if (tipo) tipo.onchange = (e)=> { state.voo.tipoVoo = e.target.value; render(); };

      // TimeFields — re-render para atualizar somatórios
      bindTimeField("l-acion", v=> { state.voo.local={...(state.voo.local||{}), acionamento:v}; render(); });
      bindTimeField("l-decol", v=> { state.voo.local={...(state.voo.local||{}), decolagem:v}; render(); });
      bindTimeField("l-pouso", v=> { state.voo.local={...(state.voo.local||{}), pouso:v}; render(); });
      bindTimeField("l-corte", v=> { state.voo.local={...(state.voo.local||{}), corte:v}; render(); });
      bindTimeField("n-acion", v=> { state.voo.navegacao={...(state.voo.navegacao||{}), acionamento:v}; render(); });
      bindTimeField("n-corte", v=> { state.voo.navegacao={...(state.voo.navegacao||{}), corte:v}; render(); });

      // pernas
      const addP = document.querySelector('[data-ev="add-perna"]'); if (addP) addP.onclick = ()=>{
        const per = state.voo.navegacao?.perna || [];
        const last = per[per.length-1] || { decolagem: state.voo.navegacao?.acionamento || "00:00", pouso: addMinutesZulu(state.voo.navegacao?.acionamento || "00:00", 30) };
        const nextDec = addMinutesZulu(last.pouso, 30);
        const nextPou = addMinutesZulu(nextDec, 30);
        state.voo.navegacao = { ...(state.voo.navegacao||{}), perna: [...per, { decolagem: nextDec, pouso: nextPou }] };
        render();
      };
      document.querySelectorAll('[data-ev="remove-perna"]').forEach(el=> el.onclick = ()=>{
        const idx = +el.getAttribute('data-idx');
        const per = [...(state.voo.navegacao?.perna||[])];
        per.splice(idx,1);
        state.voo.navegacao = { ...(state.voo.navegacao||{}), perna: per };
        render();
      });
      (state.voo.navegacao?.perna||[]).forEach((p,idx)=>{
        bindTimeField(`n-dec-${idx}`, v=>{ const per=[...(state.voo.navegacao?.perna||[])]; per[idx]={...per[idx], decolagem:v}; state.voo.navegacao={...(state.voo.navegacao||{}), perna:per}; render(); });
        bindTimeField(`n-pou-${idx}`, v=>{ const per=[...(state.voo.navegacao?.perna||[])]; per[idx]={...per[idx], pouso:v}; state.voo.navegacao={...(state.voo.navegacao||{}), perna:per}; render(); });
      });

      // Checkout
      const area = document.querySelector('[data-ev="checkout-texto"]');
      if (area) area.oninput = (e)=> state.checkoutTexto = e.target.value;
      const shareC = document.querySelector('[data-ev="share-checkout"]');
      if (shareC) shareC.onclick = ()=>{
        const cabecalho = [
          `Aluno: ${state.form.nomeAluno || '-'}`,
          `CANAC: ${state.form.canacAluno || '-'}`,
          `Data do voo: ${state.form.dataVoo || '-'}`
        ].join('\n');
        const blocoVoo = formatInfoVooForText();
        const corpo = state.checkoutTexto || "";
        const msg = `${cabecalho}\n\n${blocoVoo}${corpo}`.trim();
        shareWhatsApp(msg);
      };
    }

    // ==========================
    // Relógio Zulu
    // ==========================
    function tick(){
      state.clockZulu = dateToZuluHM(new Date());
      const el = document.getElementById("clockZulu");
      if (el) el.textContent = state.clockZulu + "Z";
    }

    // ==========================
    // Init
    // ==========================
    document.getElementById("year").textContent = new Date().getFullYear();
    setInterval(tick, 1000);
    render();
    loadAllDatasets();

    // Testes rápidos (console) — não alterar os existentes
    console.assert(diffHMtoMinutes('10:00','11:30')===90, '10:00-11:30=90');
    console.assert(minutesToHHMM(110)==='01:50', '110->01:50');
    console.assert(minutesToDecimalTenthsStr(110)==='1,8','110->1,8h');
    console.assert(minutesToDecimalTenthsStr(63)==='1,0','63->1,0h (trunc)');
    console.assert(addMinutesZulu('23:50',20)==='00:10','rollover ok');

    // Testes adicionais (CSV/rollover)
    console.assert(diffHMtoMinutes('23:50','00:10')===20, 'overnight 23:50-00:10=20');
    console.assert(diffHMtoMinutes('00:00','00:00')===0, '00:00-00:00=0');
    console.assert(minutesToHHMM(0)==='00:00','0->00:00');
    console.assert(minutesToDecimalTenthsStr(5)==='0,0','5min->0,0h (trunc)');
    console.assert(minutesToDecimalTenthsStr(6)==='0,1','6min->0,1h');
    // smoke test: após carregar, deve haver ao menos 1 missão em alguma fase
    setTimeout(()=>{
      const someCount = (MISSOES_POR_FASE.PP?.length||0) + (MISSOES_POR_FASE.PC?.length||0) + (MISSOES_POR_FASE.INVA?.length||0);
      console.assert(someCount>0, 'CSV não populou nenhuma missão (possível CORS).');
    }, 2000);
    console.assert(diffHMtoMinutes('00:00','00:00')===0, '00:00-00:00=0');
    console.assert(minutesToHHMM(0)==='00:00','0->00:00');
    console.assert(minutesToDecimalTenthsStr(5)==='0,0','5min->0,0h (trunc)');
    console.assert(minutesToDecimalTenthsStr(6)==='0,1','6min->0,1h');
  </script>
</body>
</html>
