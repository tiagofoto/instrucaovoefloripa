<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Instrução de Voo – Floripa</title>
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body { background: #f3f4f6; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .container { max-width: 420px; margin: 0 auto; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .pad { padding: 12px; } .pad-lg { padding: 16px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .col { display: flex; flex-direction: column; gap: 8px; }
    .gap-12 { gap: 12px; } .gap-16 { gap: 16px; }
    .btn { padding: 8px 12px; border-radius: 12px; border: 1px solid #e5e7eb; background: #fff; font-size: 12px; cursor: pointer; }
    .btn-primary { background: #111; color: #fff; border-color: #111; }
    .btn-danger { color: #b91c1c; border-color: #fecaca; }
    .input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; }
    label { font-size: 13px; color: #374151; }
    .tabs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .tab { padding: 8px 0; border-radius: 12px; background: #e5e7eb; border: 0; cursor: pointer; }
    .tab.active { background: #111; color: #fff; }
    .footer { color: #9ca3af; font-size: 12px; text-align: center; padding: 24px 0; }
    .zulu { position: sticky; bottom: 12px; background: #111; color: #fff; text-align: center; padding: 10px 12px; border-radius: 12px; font-size: 18px; }
    ul { margin: 4px 0 0 16px; padding: 0; } li { list-style: none; }
  </style>
</head>
<body>
  <div class="container">
    <header class="pad" style="position:sticky;top:0;background:#fff;backdrop-filter:blur(4px);border-bottom:1px solid #e5e7eb;z-index:10">
      <div class="pad row" style="justify-content:space-between">
        <div style="font-weight:600">InstrucaoaovoeFloripa</div>
        <div style="font-size:12px;color:#6b7280">Protótipo</div>
      </div>
      <nav class="pad" style="padding-top:0">
        <div id="tabs" class="tabs"></div>
      </nav>
    </header>

    <main id="app" class="pad"></main>

    <footer class="footer">© <span id="year"></span> — Protótipo para instrutores de voo</footer>
  </div>

  <script>
    // ==========================
    // DADOS (parcial — amplie quando quiser)
    // ==========================
    const MISSOES = {
      PP: {
        "PS-01": {
          tempo_voo: "01:00:00",
          pousos: 1,
          conteudo: [
            "Mudanças de Atitude (Subidas, descidas e nivelamento); Curvas de Pequena inclinação; Voo Planado"
          ],
          pre_requisitos: ["CMA", "Ground School"],
          registro: "DC",
          competencias: ["Commitment (CMT)", "Application of Knowledge (KNO)", "Communication (COM)"]
        },
        "PS-02": {
          tempo_voo: "01:00:00",
          pousos: 1,
          conteudo: [
            "Coordenação de comandos; Curvas de Média inclinação; Perda de Sustentação"
          ],
          pre_requisitos: ["PS-01"],
          registro: "DC",
          competencias: ["CMT", "KNO", "COM"]
        }
      },
      PC: {},
      INVA: {}
    };

    const FASES = ["PP", "PPR", "PC", "INVA", "PLA"];
    const MISSOES_POR_FASE = {
      PP: [
        "PS-01","PS-02","PS-03","PS-04","PS-05","PS-06","PS-07","PS-08","PS-09","PS-10",
        "PS-11","PS-12","PS-13","PS-14","PS-15","PS-16","PS-17","PS-X1","PS-18",
        "AP-01","AP-02","AP-03","AP-04","AP-05","AP-06","AP-07","AP-08","AP-09",
        "NV-01","NV-02","NV-03","NV-X1",
        "NT-01","NT-02","NT-03",
        "PRCQ","CQPP"
      ],
      PPR: [
        "PS-03","PS-05","PS-07","PS-10","PS-15","PS-17","PS-X1","PS-18",
        "AP-01","AP-05","AP-06","AP-07","AP-08","AP-09",
        "NV-01","NV-02","NV-03","NV-X1",
        "NT-01","NT-02","NT-03",
        "PRCQ","CQPP"
      ],
      PC: [
        "AD-01","AD-02","AD-03","AD-04","AD-05","AD-06","AD-07","AD-08",
        "AP-01","AP-02","AP-03","AP-04","AP-05","AP-06","AP-07","AP-08",
        "MB-01","MB-02","MB-03","MB-04","MB-05","MB-06",
        "NV-01","NV-02","NV-03","NV-04","NV-05","NV-06","NV-07","NV-08",
        "NV-09","NV-10","NV-11","NV-12","NV-13","NV-14","NV-15",
        "NT-01","NT-02","NT-03","NT-04","NT-05",
        "PRCQ","CQPP"
      ],
      INVA: [
        "PI-01","PI-02","PI-03","PI-04","PI-05","PI-06","PI-07","PI-08",
        "PI-09","PI-10","PI-11","PI-12","PI-13","PI-14","PI-15","PI-16",
        "NV-01","NV-02","PRCQ","CQPP"
      ],
      PLA: []
    };

    const AERONAVES = ["PR-FLE","PR-FLD","PR-FLN","PT-MJF","PR-MGX","PR-FLM"];
    const TIPOS_VOO = ["Local","Navegação"];

    // ==========================
    // STATE
    // ==========================
    const state = {
      aba: "Inicial",
      form: { nomeAluno:"", canacAluno:"", dataVoo:"", fase:"PP", missoes:[""] },
      voo: { tipoVoo:"Local", aeronave:"", local:{}, navegacao:{} },
      clockZulu: "--:--"
    };

    // ==========================
    // HORA ZULU helpers
    // ==========================
    const pad2 = (n)=> String(n).padStart(2,"0");
    const dateToZuluHM = (d)=> `${pad2(d.getUTCHours())}:${pad2(d.getUTCMinutes())}`;
    const addMinutesZulu = (baseHM, minutes) => {
      const [h,m] = baseHM.split(":").map(Number);
      const base = new Date(); base.setUTCHours(h, m, 0, 0);
      const nd = new Date(base.getTime() + minutes*60*1000);
      return dateToZuluHM(nd);
    };
    const diffHMtoMinutes = (startHM, endHM) => {
      const [sh, sm] = startHM.split(":").map(Number);
      const [eh, em] = endHM.split(":").map(Number);
      let start = sh*60 + sm; let end = eh*60 + em; if (end < start) end += 24*60;
      return end - start;
    };
    const minutesToHHMM = (mins)=> `${pad2(Math.floor(mins/60))}:${pad2(mins%60)}`;
    const minutesToDecimalTenths = (mins)=> (Math.floor(mins/6)/10).toFixed(1);

    // ==========================
    // WHATSAPP
    // ==========================
    async function shareWhatsApp(text, numero){
      try {
        if (navigator.share && (!navigator.canShare || navigator.canShare({text}))){
          await navigator.share({ text });
          return;
        }
      } catch {}
      const base = numero ? `https://wa.me/${numero}?text=` : `https://api.whatsapp.com/send?text=`;
      const url = base + encodeURIComponent(text);
      window.open(url, "_blank");
    }

    // ==========================
    // RENDER helpers
    // ==========================
    function Field(label, innerHTML){
      return `<div class="col"><label>${label}</label>${innerHTML}</div>`;
    }
    function Select(options, value, attrs=""){
      const opts = options.map(o=>`<option value="${o}">${o}</option>`).join("");
      return `<select ${attrs}>${opts}</select>`;
    }
    function TimeField(id, label, value){
      const [hh="00", mm="00"] = (String(value||"00:00").split(":").map(x=>pad2(+x||0)));
      const HOURS = Array.from({length:24}, (_,i)=>pad2(i)).map(h=>`<option value="${h}">${h}</option>`).join("");
      const MINUTES = Array.from({length:60}, (_,i)=>pad2(i)).map(m=>`<option value="${m}">${m}</option>`).join("");
      return `
        <div class="col">
          <label>${label}</label>
          <div class="row">
            <select data-id="${id}" data-part="hh">${HOURS}</select>
            <span>:</span>
            <select data-id="${id}" data-part="mm">${MINUTES}</select>
            <button class="btn" data-id="${id}" data-action="nowz">Agora (Z)</button>
          </div>
          <input type="hidden" id="${id}" value="${hh}:${mm}" />
        </div>
        <script>
          (function(){
            const hh = document.querySelector('select[data-id="${id}"][data-part="hh"]');
            const mm = document.querySelector('select[data-id="${id}"][data-part="mm"]');
            const hidden = document.getElementById('${id}');
            hh.value='${hh}'; mm.value='${mm}';
            function update(){ hidden.value = \`\${hh.value}:\${mm.value}\`; hidden.dispatchEvent(new Event('change')); }
            hh.onchange=update; mm.onchange=update;
            const btn = document.querySelector('button[data-id="${id}"][data-action="nowz"]');
            btn.onclick = ()=>{ const n = new Date(); hh.value='${'${'}pad2(n.getUTCHours())${'}'}'; mm.value='${'${'}pad2(n.getUTCMinutes())${'}'}'; update(); };
          })();
        </script>
      `;
    }

    function semicolonSplitToItems(raw){
      const arr = Array.isArray(raw) ? raw : [String(raw||"")];
      return arr.flatMap(s=> String(s).split(";"))
                .map(x=>x.trim())
                .filter(Boolean);
    }
    function formatMissoesForText(dataset, codes){
      const blocks = [];
      (codes||[]).forEach(code=>{
        const d = dataset?.[code];
        blocks.push(`Missão ${code}`);
        const itens = d ? semicolonSplitToItems(d.conteudo) : [];
        itens.forEach((item, idx)=> blocks.push(`- ${item}${idx < itens.length-1 ? ';' : ''}`));
        if (!itens.length) blocks.push('- (sem itens)');
        blocks.push('');
      });
      return blocks.join('\n');
    }

    // ==========================
    // PÁGINAS
    // ==========================
    function PageInicial(){
      const todayISO = new Date().toISOString().slice(0,10);
      if (!state.form.dataVoo) state.form.dataVoo = todayISO;

      const missoesHTML = state.form.missoes.map((m,idx)=>`
        <div class="card pad row" style="align-items:center">
          ${Select(["",...MISSOES_POR_FASE[state.form.fase||"PP"]], m, `data-ev="missao" data-idx="${idx}" class="input"`)}
          <button class="btn btn-danger" data-ev="remove-missao" data-idx="${idx}">Remover</button>
        </div>
      `).join("");

      return `
        <div class="pad-lg col gap-16">
          <div class="col gap-12">
            ${Field("Nome do Aluno", `<input class="input" value="${state.form.nomeAluno||""}" data-ev="nomeAluno" placeholder="Digite o nome" />`)}
            ${Field("CANAC do Aluno", `<input class="input" value="${state.form.canacAluno||""}" data-ev="canacAluno" placeholder="Ex.: 123456" />`)}
            ${Field("Data do Voo", `<input type="date" class="input" value="${state.form.dataVoo||todayISO}" data-ev="dataVoo" />`)}
            ${Field("Fase da Instrução", Select(FASES, state.form.fase||"PP", `data-ev="fase" class="input"`))}
          </div>

          <div class="col gap-12">
            <div class="row" style="justify-content:space-between">
              <span style="font-size:13px;color:#374151">Missões</span>
              <button class="btn btn-primary" data-ev="add-missao">+ Adicionar</button>
            </div>
            <div class="col gap-12">${missoesHTML}</div>
          </div>
        </div>
      `;
    }

    function pageInfoResultados(){
      if ((state.voo.tipoVoo||"Local") === "Local"){
        const minsTotal = diffHMtoMinutes(state.voo.local?.acionamento||"00:00", state.voo.local?.corte||"00:00");
        const minsVoo = diffHMtoMinutes(state.voo.local?.decolagem||"00:00", state.voo.local?.pouso||"00:00");
        return {
          totalHHMM: minutesToHHMM(minsTotal),
          totalDecimal: minutesToDecimalTenths(minsTotal),
          vooHHMM: minutesToHHMM(minsVoo),
          vooDecimal: minutesToDecimalTenths(minsVoo),
          pernas:[]
        };
      } else {
        const acion = state.voo.navegacao?.acionamento || "00:00";
        const corte = state.voo.navegacao?.corte || "00:00";
        const minsTotal = diffHMtoMinutes(acion, corte);
        const pernas = (state.voo.navegacao?.perna||[]).map(p=>{
          const mm = diffHMtoMinutes(p.decolagem||"00:00", p.pouso||"00:00");
          return { ...p, hhmm: minutesToHHMM(mm), dec: minutesToDecimalTenths(mm) };
        });
        return {
          totalHHMM: minutesToHHMM(minsTotal),
          totalDecimal: minutesToDecimalTenths(minsTotal),
          vooHHMM:null,
          vooDecimal:null,
          pernas
        };
      }
    }

    function PageInfoVoo(){
      // Pré-preencher se vazio
      const nowHM = dateToZuluHM(new Date());
      if (!state.voo.local?.acionamento && state.voo.tipoVoo !== "Navegação"){
        const acion = nowHM;
        const deco = addMinutesZulu(acion, 10);
        const pouso = addMinutesZulu(acion, 55);
        const corte = addMinutesZulu(acion, 60);
        state.voo = {
          aeronave: state.voo.aeronave || "",
          tipoVoo: state.voo.tipoVoo || "Local",
          local: { acionamento: acion, decolagem: deco, pouso, corte },
          navegacao: state.voo.navegacao || { acionamento: acion, perna: [{ decolagem: deco, pouso: addMinutesZulu(deco,30) }], corte }
        };
      }

      const selecaoTipo = Select(TIPOS_VOO, state.voo.tipoVoo||"Local", 'data-ev="tipoVoo" class="input"');
      const selecaoAeronave = Select(["",...AERONAVES], state.voo.aeronave||"", 'data-ev="aeronave" class="input"');

      const tipoLocal = `
        ${TimeField("local-acion", "Acionamento (Zulu)", state.voo.local?.acionamento||"")}
        ${TimeField("local-decol", "Decolagem (Zulu)", state.voo.local?.decolagem||"")}
        ${TimeField("local-pouso", "Pouso (Zulu)", state.voo.local?.pouso||"")}
        ${TimeField("local-corte", "Corte (Zulu)", state.voo.local?.corte||"")}
      `;

      const pernasHTML = (state.voo.navegacao?.perna||[]).map((p,idx)=>`
        <div class="card pad">
          <div class="row" style="justify-content:space-between">
            <span style="font-size:13px;font-weight:600">Perna ${idx+1}</span>
            <button class="btn btn-danger" data-ev="remove-perna" data-idx="${idx}">Remover</button>
          </div>
          <div class="col gap-12">
            ${TimeField(`nav-dec-${idx}`,"Decolagem (Zulu)", p.decolagem)}
            ${TimeField(`nav-pou-${idx}`,"Pouso (Zulu)", p.pouso)}
          </div>
        </div>
      `).join("");

      const tipoNav = `
        ${TimeField("nav-acion","Acionamento (Zulu)", state.voo.navegacao?.acionamento||"")}
        ${pernasHTML}
        <button class="btn btn-primary" data-ev="add-perna">+ Adicionar Decolagem/Pouso</button>
        ${TimeField("nav-corte","Corte (Zulu)", state.voo.navegacao?.corte||"")}
      `;

      const r = pageInfoResultados();

      return `
        <div class="pad-lg col gap-16">
          <div class="col gap-12">
            ${Field("Aeronave", selecaoAeronave)}
            ${Field("Tipo de Voo", selecaoTipo)}
          </div>

          ${(state.voo.tipoVoo||"Local")==="Local" ? `<div class="col gap-12">${tipoLocal}</div>` : `<div class="col gap-12">${tipoNav}</div>`}

          <div class="card pad">
            <div style="font-size:13px;color:#4b5563;margin-bottom:4px">Somatórios</div>
            <div style="font-size:14px">Total (Acionamento → Corte): <b>${r.totalHHMM}</b> – <b>${r.totalDecimal} h</b></div>
            ${(state.voo.tipoVoo||"Local")==="Local"
              ? `<div style="font-size:14px">Decolagem → Pouso: <b>${r.vooHHMM}</b> – <b>${r.vooDecimal} h</b></div>`
              : `<div class="col">${r.pernas.map((p,i)=>`<div style="font-size:14px">Perna ${i+1} (Dec→Pou): <b>${p.hhmm}</b> – <b>${p.dec} h</b></div>`).join("")}</div>`
            }
          </div>

          <div class="zulu">Horário Zulu: <b id="clockZulu">${state.clockZulu}Z</b></div>
        </div>
      `;
    }

    function datasetByFase(fase){
      if (fase==="PC") return MISSOES.PC;
      if (fase==="INVA") return MISSOES.INVA;
      if (fase==="PP" || fase==="PPR") return MISSOES.PP;
      return {};
    }

    function PageFichaTecnica(){
      const ds = datasetByFase(state.form.fase);
      const selecionadas = (state.form.missoes||[]).filter(Boolean);
      const infos = selecionadas.map(code => ({ code, data: ds?.[code] }));

      const itensHTML = infos.map(m=>`
        <div class="card pad">
          <div style="font-size:16px;font-weight:600;margin-bottom:8px">Missão: ${m.code}</div>
          ${
            !m.data
            ? `<div style="color:#b91c1c;font-size:13px">Não encontrado na base de dados embutida.</div>`
            : `
              <div class="col">
                <div><b>Tempo de Voo:</b> ${m.data.tempo_voo||"-"}</div>
                <div><b>Pousos:</b> ${m.data.pousos ?? "-"}</div>
                <div><b>Pré-requisitos:</b> ${(m.data.pre_requisitos||[]).join(", ") || "-"}</div>
                <div><b>Registro:</b> ${m.data.registro||"-"}</div>
                <div><b>Competências:</b> ${(m.data.competencias||[]).join(", ") || "-"}</div>
                <div>
                  <b>Conteúdo / Manobras:</b>
                  <div style="margin-top:4px">Missão ${m.code}</div>
                  <ul>
                    ${
                      (semicolonSplitToItems(m.data.conteudo)).map((c,i,arr)=> `<li>- ${c}${i < arr.length-1 ? ';' : ''}</li>`).join("")
                    }
                  </ul>
                </div>
              </div>
            `
          }
        </div>
      `).join("");

      return `
        <div class="pad-lg col gap-16">
          ${infos.length===0 ? `<div style="color:#6b7280;font-size:13px">Selecione ao menos uma missão na página inicial.</div>` : ""}
          <button class="btn btn-primary" data-ev="share-ficha">Compartilhar WhatsApp</button>
          ${itensHTML}
        </div>
      `;
    }

    function PageCheckout(){
      const ds = datasetByFase(state.form.fase);
      const selecionadas = (state.form.missoes||[]).filter(Boolean);
      if (!state._checkoutInit){
        const linhas=[];
        selecionadas.forEach(code=>{
          const d = ds?.[code];
          linhas.push(`Missão ${code}`);
          if (d && d.conteudo){
            const itens = semicolonSplitToItems(d.conteudo);
            itens.forEach((it,idx)=> linhas.push(`- ${it}${idx < itens.length-1 ? ';' : ''}`));
          }
          linhas.push("");
        });
        state.checkoutTexto = linhas.join("\n");
        state._checkoutInit = true;
      }
      return `
        <div class="pad-lg col gap-12">
          <div style="color:#6b7280;font-size:13px">Escreva aqui sua avaliação (livre). O texto vem pré-preenchido com o descritivo da(s) missão(ões), podendo ser editado.</div>
          <div class="row">
            <button class="btn btn-primary" data-ev="share-checkout">Compartilhar WhatsApp</button>
          </div>
          <textarea class="input" style="min-height:240px" data-ev="checkout-texto">${state.checkoutTexto||""}</textarea>
        </div>
      `;
    }

    // ==========================
    // RENDER raiz
    // ==========================
    function render(){
      // tabs
      const tabs = ["Inicial","Informações do voo","Ficha Técnica","Check-out"];
      document.getElementById("tabs").innerHTML = tabs.map(t=>`
        <button class="tab ${state.aba===t?"active":""}" data-aba="${t}">${t}</button>
      `).join("");

      // page
      const app = document.getElementById("app");
      app.innerHTML =
        state.aba==="Inicial" ? PageInicial()
      : state.aba==="Informações do voo" ? PageInfoVoo()
      : state.aba==="Ficha Técnica" ? PageFichaTecnica()
      : PageCheckout();

      bindEvents();
    }

    // ==========================
    // Event binding por página
    // ==========================
    function bindEvents(){
      // tabs
      document.querySelectorAll('[data-aba]').forEach(el=>{
        el.onclick = ()=> { state.aba = el.getAttribute('data-aba'); if (state.aba!=="Check-out") state._checkoutInit = false; render(); };
      });

      // INICIAL
      document.querySelectorAll('[data-ev="nomeAluno"]').forEach(el=> el.oninput = e=> state.form.nomeAluno = e.target.value );
      document.querySelectorAll('[data-ev="canacAluno"]').forEach(el=> el.oninput = e=> state.form.canacAluno = e.target.value );
      document.querySelectorAll('[data-ev="dataVoo"]').forEach(el=> el.oninput = e=> state.form.dataVoo = e.target.value );
      const faseEl = document.querySelector('[data-ev="fase"]'); if (faseEl) faseEl.onchange = e=> { state.form.fase = e.target.value; state.form.missoes = [""]; render(); };
      document.querySelectorAll('[data-ev="missao"]').forEach(el=> el.onchange = e=>{
        const idx = +el.getAttribute('data-idx'); state.form.missoes[idx] = e.target.value;
      });
      const addM = document.querySelector('[data-ev="add-missao"]'); if (addM) addM.onclick = ()=> { state.form.missoes.push(""); render(); };
      document.querySelectorAll('[data-ev="remove-missao"]').forEach(el=> el.onclick = ()=>{
        const idx = +el.getAttribute('data-idx'); state.form.missoes = state.form.missoes.filter((_,i)=> i!==idx); render();
      });

      // INFO VOO
      const aer = document.querySelector('[data-ev="aeronave"]'); if (aer) aer.onchange = e=> state.voo.aeronave = e.target.value;
      const tipo = document.querySelector('[data-ev="tipoVoo"]'); if (tipo) tipo.onchange = e=> { state.voo.tipoVoo = e.target.value; render(); };

      // TimeField Local
      bindHM("local-acion", (val)=> { state.voo.local = {...state.voo.local, acionamento:val}; });
      bindHM("local-decol", (val)=> { state.voo.local = {...state.voo.local, decolagem:val}; });
      bindHM("local-pouso", (val)=> { state.voo.local = {...state.voo.local, pouso:val}; });
      bindHM("local-corte", (val)=> { state.voo.local = {...state.voo.local, corte:val}; });

      // TimeField Navegação
      bindHM("nav-acion",(val)=> { state.voo.navegacao = {...state.voo.navegacao, acionamento:val}; });
      bindHM("nav-corte",(val)=> { state.voo.navegacao = {...state.voo.navegacao, corte:val}; });

      // pernas
      const addP = document.querySelector('[data-ev="add-perna"]'); if (addP) addP.onclick = ()=>{
        const per = state.voo.navegacao?.perna || [];
        const last = per[per.length-1] || { decolagem: state.voo.navegacao?.acionamento || "00:00", pouso: addMinutesZulu(state.voo.navegacao?.acionamento || "00:00", 30) };
        const nextDec = addMinutesZulu(last.pouso, 30);
        const nextPou = addMinutesZulu(nextDec, 30);
        state.voo.navegacao = { ...(state.voo.navegacao||{}), perna: [...per, { decolagem: nextDec, pouso: nextPou }] };
        render();
      };
      document.querySelectorAll('[data-ev="remove-perna"]').forEach(el=> el.onclick = ()=>{
        const idx = +el.getAttribute('data-idx');
        const per = [...(state.voo.navegacao?.perna||[])];
        per.splice(idx,1);
        state.voo.navegacao = { ...(state.voo.navegacao||{}), perna: per };
        render();
      });
      // binds HM para cada perna
      (state.voo.navegacao?.perna||[]).forEach((p,idx)=>{
        bindHM(`nav-dec-${idx}`, (val)=>{ const per=[...(state.voo.navegacao?.perna||[])]; per[idx]={...per[idx], decolagem:val}; state.voo.navegacao={...(state.voo.navegacao||{}), perna:per}; });
        bindHM(`nav-pou-${idx}`, (val)=>{ const per=[...(state.voo.navegacao?.perna||[])]; per[idx]={...per[idx], pouso:val}; state.voo.navegacao={...(state.voo.navegacao||{}), perna:per}; });
      });

      // FICHA TÉCNICA
      const btnShareF = document.querySelector('[data-ev="share-ficha"]');
      if (btnShareF) btnShareF.onclick = ()=>{
        const ds = datasetByFase(state.form.fase);
        const codes = (state.form.missoes||[]).filter(Boolean);
        const text = formatMissoesForText(ds, codes);
        shareWhatsApp(text);
      };

      // CHECK-OUT
      const area = document.querySelector('[data-ev="checkout-texto"]');
      if (area) area.oninput = e=> state.checkoutTexto = e.target.value;
      const btnShareC = document.querySelector('[data-ev="share-checkout"]');
      if (btnShareC) btnShareC.onclick = ()=> shareWhatsApp(state.checkoutTexto || "");
    }

    function bindHM(id, setter){
      const hidden = document.getElementById(id);
      if (!hidden) return;
      hidden.addEventListener('change', ()=> setter(hidden.value));
    }

    // ==========================
    // Relógio Zulu
    // ==========================
    function tick(){
      state.clockZulu = dateToZuluHM(new Date());
      const el = document.getElementById("clockZulu");
      if (el) el.textContent = state.clockZulu + "Z";
    }

    // ==========================
    // Inicialização
    // ==========================
    document.getElementById("year").textContent = new Date().getFullYear();
    setInterval(tick, 1000);
    render();

    // Testes rápidos no console
    console.assert(diffHMtoMinutes('10:00','11:30')===90, '10:00-11:30=90');
    console.assert(minutesToHHMM(110)==='01:50', '110->01:50');
    console.assert(minutesToDecimalTenths(110)==='1.8','110->1.8h');
    console.assert(addMinutesZulu('23:50',20)==='00:10','rollover ok');
  </script>
</body>
</html>
